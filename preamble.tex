% !TeX program = lualatex
% Layout
\documentclass[9pt,openany]{book}
\usepackage[paperwidth=6in,paperheight=9in,top=0.3in,bottom=0.7in,left=0.4in,right=0.4in,bindingoffset=0.2in,includehead,headsep=7pt]{geometry}
\usepackage{setspace} % for line spacing
\usepackage{microtype} % helps with formatting
\usepackage{emptypage}
\usepackage[all]{nowidow}
\usepackage{ragged2e} % Nicer ragged edges. Use \Center to get nice balanced lines
\usepackage{bookmark} %add PDF bookmarks for each \chapter
\usepackage{hyperref} % Make the TOC clickable
\usepackage{fontspec}
\setmainfont{Gentium}

% \usepackage[greek]{babel} % use with pdfLaTeX, not XeLaTeX
\usepackage{polyglossia}
\setmainlanguage{greek}

% Define colors
\usepackage{xcolor}
\definecolor{bookheadingcolor}{HTML}{9B3A3F}
\definecolor{versenumbercolor}{HTML}{909090}
\definecolor{altchaptercolor}{HTML}{1C2D5C}

% % Use a different font for Greek (with Latin fallback)
% % https://tex.stackexchange.com/a/619560/319804
% \directlua{luaotfload.add_fallback("myfallback",{"Gentium:mode=harf;",})}
% \setmainfont{GFS Porson}[RawFeature={fallback=myfallback}]

\flushbottom
\frenchspacing % stops extra space after a period or colon
\hyphenpenalty=2000
\emergencystretch=1pt
\setlength{\parindent}{.2in} % Set paragraph indentation
\setlength{\parskip}{0pt}

\usepackage{titlesec}
\renewcommand{\thechapter}{} % remove numbers from chapter
% Show chapter titles with a line after them
\titleformat{\chapter}[display]
{\filcenter\normalfont\Huge}{}{0pt}{}
[\vspace{.5ex}\rule{1.5in}{0.4pt}]

% Add the multicol package for two-column layout
\usepackage{multicol}
\setlength{\columnsep}{.4cm} % Set the columnn width

% Adjust spacing and format of TOC 
\usepackage{tocloft}
\renewcommand{\cftchapfont}{\raggedright}    % Book names left-justified
\renewcommand{\cftchappagefont}{\raggedleft} % Page numbers right-justified
\renewcommand{\cftdotsep}{2}                 % change the default spacing of dots
\renewcommand{\cftchapleader}{\cftdotfill{\cftdotsep}} % Add leader dots for chapters
\setlength{\cftbeforechapskip}{1pt}          % Adjust the space before each TOC chapter entry

% Adjust the width of the TOC
\setlength{\cftchapindent}{0em}              % No indent
\setlength{\cftchapnumwidth}{0em}            % No space reserved for chapter numbers

\newcommand{\psalmheading}[1]{%
  \begin{center}
    {\itshape #1}% % Italicize text
  \end{center}
}

% Set up chapter/verse references in headers
% https://tex.stackexchange.com/a/657575/319804
\usepackage{fancyhdr}
\pagestyle{fancy}
\newcounter{mychapter}
\newcounter{verse}
\def\book{}
\fancyhead{}
\fancyhead[LE]{\rightmark}
\fancyhead[OR]{\leftmark}
\fancyfoot{}
\fancyfoot[C]{\thepage}
\renewcommand{\headrulewidth}{0pt}

\newcommand{\ch}[1]{%
  \setcounter{mychapter}{#1}%
  \markboth{\book\ \themychapter:1}{\book\ \themychapter:1}%
  \textbf{#1}%
}
\newcommand{\vs}[1]{%
  \textsuperscript{\textcolor{versenumbercolor}{#1}}%
  \markboth{\book\ \themychapter:#1}{\book\ \themychapter:#1}%
}

\let\biblebook\chapter % rename \chapter so it's not confusing

% \newenvironment{psalmhead}[1]{%
%     \par\addvspace{\baselineskip}%
%     \noindent%
%     \begin{minipage}[b]{\columnwidth}%
%         \begin{Center}%
%             {#1}%
%         \end{Center}%
% }{%
%     \end{minipage}%
% }

% Chapter and Heading Styles

\let\oldbiblebook\biblebook
\renewcommand{\biblebook}[1]{%
  \setcounter{mychapter}{1}%
  \textcolor{bookheadingcolor}{\oldbiblebook{#1}}%
  \markboth{\book\ \themychapter:#1}{\book\ \themychapter:#1}%
}

\let\oldch\ch
\renewcommand{\ch}[1]{%
  \setcounter{mychapter}{#1}%
  \markboth{\book\ \themychapter:1}{\book\ \themychapter:1}%
  \leavevmode\llap{\textcolor{bookheadingcolor}{\textbf{\oldch{#1}}\hspace*{2em}}}%
}

\usepackage{tikz}
\newcommand{\leftabsblock}[2]{%
  \begin{tikzpicture}[remember picture,overlay]
    \node[anchor=base west] at ([xshift=#1]current page.west|-here) {#2};
  \end{tikzpicture}%
}

\newcommand{\rightabsblock}[2]{%
  \begin{tikzpicture}[remember picture,overlay]
    \node[anchor=base east] at ([xshift=-#1]current page.east|-here) {#2};
  \end{tikzpicture}%
}

\usepackage{ifoddpage}
\usepackage{marginnote}
\newcommand{\inparch}[1]{%
  \setcounter{mychapter}{#1}%
  \markboth{\book\ \themychapter:1}{\book\ \themychapter:1}%
  \checkoddpage
  \ifoddpage
    \tikz[remember picture] \coordinate (here);%
    \rightabsblock{13.76cm}{\textcolor{bookheadingcolor}{\textbf{\oldch{#1}}}}%
  \else
    \tikz[remember picture] \coordinate (here);%
    \rightabsblock{14.26cm}{\textcolor{bookheadingcolor}{\textbf{\oldch{#1}}}}%
  \fi
}

\usepackage{lettrine}
\usepackage{calc}

\newcommand{\postdropcapindent}{\hspace*{.2in + .8em}}

\newenvironment{poetryblock}
  {%
    \vspace{0.5\baselineskip}%
    \setlength{\topsep}{0pt}%
    \setlength{\partopsep}{0pt}%
    \begin{list}{}%
      {%
        \setlength{\leftmargin}{2em}   % Change left margin
        \setlength{\rightmargin}{2em}  % Change right margin
        \setlength{\topsep}{0pt}
        \setlength{\partopsep}{0pt}
        \setlength{\parsep}{0pt}
        \setlength{\itemsep}{0pt}
      }%
    \item\relax
    \itshape                    % Italicize text
    % Locally redefine quote environment for this block
    \renewenvironment{quote}
      {\list{}{\rightmargin=1em \leftmargin=1em
        \topsep=0pt \partopsep=0pt \parsep=0pt \itemsep=0pt}\item\relax}
      {\endlist}
  }
  {%
    \end{list}%
    \vspace{0.5\baselineskip}%
  }

  \usepackage{needspace}
  \let\origch\ch
  \newenvironment{psalms}
    {
      \renewcommand{\ch}[2]{%
        \setcounter{mychapter}{##1}%
        \markboth{\book\ \themychapter:1}{\book\ \themychapter:1}%
        \vspace{\baselineskip}
        \Needspace{6\baselineskip}
        \begin{center}
          {\upshape{\Large\textbf{\textcolor{bookheadingcolor}{ΨΑΛΜΟΣ ##1}}}}\\
          {\itshape{\textbf{\textcolor{bookheadingcolor}{(ΚΑΤΑ ΜΑΣΟΡΙΤΙΚΟΝ ##2)}}}}
        \end{center}
      }
      \newcommand{\masch}[1]{%
      }
    }
    {
      \renewcommand{\ch}{\origch}
    }

\sloppy

\usepackage{tocloft}
\setlength{\cftbeforepartskip}{1.4em}
\renewcommand{\cftpartfont}{\large\bfseries\color{bookheadingcolor}}